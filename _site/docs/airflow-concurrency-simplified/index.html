<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Anuradha Chowdhary" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Anuradha Chowdhary" /> <title> Airflow Concurrency Configuration Simplified! - Anuradha Chowdhary </title> <link rel="alternate" href="http://ec2-13-233-172-79.ap-south-1.compute.amazonaws.com:4000/airflow-concurrency-simplified/" hreflang="en-US" /> <link rel="canonical" href="http://ec2-13-233-172-79.ap-south-1.compute.amazonaws.com:4000/airflow-concurrency-simplified/" /> <meta name="description" content="Anuradha Chowdhary is Technology Leader, programmer, entreprenuer and promoter of Women in Tech and Open Source Software. for her work see @github." /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="Airflow Concurrency Configuration Simplified! | Anuradha Chowdhary" /> <meta property="og:title" content="Airflow Concurrency Configuration Simplified! | Anuradha Chowdhary" /> <meta property="og:type" content="website" /> <meta property="og:url" content="http://ec2-13-233-172-79.ap-south-1.compute.amazonaws.com:4000/airflow-concurrency-simplified/" /> <meta property="og:description" content="Anuradha Chowdhary is Technology Leader, programmer, entreprenuer and promoter of Women in Tech and Open Source Software. for her work see @github." /> <meta property="og:image" content="http://ec2-13-233-172-79.ap-south-1.compute.amazonaws.com:4000/airflow-concurrency-simplified/airflow.jpeg" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Airflow Concurrency Configuration Simplified! | anu2602" /> <meta name="twitter:url" content="http://ec2-13-233-172-79.ap-south-1.compute.amazonaws.com:4000/airflow-concurrency-simplified/" /> <meta name="twitter:site" content="@anu2602" /> <meta name="twitter:creator" content="@anu2602" /> <meta name="twitter:description" content="Anuradha Chowdhary is Technology Leader, programmer, entreprenuer and promoter of Women in Tech and Open Source Software. for her work see @github." /> <meta name="twitter:image" content="http://ec2-13-233-172-79.ap-south-1.compute.amazonaws.com:4000/airflow-concurrency-simplified/airflow.jpeg" /> <link type="application/atom+xml" rel="alternate" href="http://ec2-13-233-172-79.ap-south-1.compute.amazonaws.com:4000/feed.xml" title="Anuradha Chowdhary" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> </head> <body data-theme="dark" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">home</a><a class="menu-link" href="/archive/">posts</a><a class="menu-link" href="/about/">about</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/tags/#airflow">AIRFLOW</a>, <a class="tag" href="/tags/#prod">PROD</a> </span> </div> <h1 class="header-title" itemprop="headline">Airflow Concurrency Configuration Simplified!</h1> <div class="post-meta"> <time datetime="2020-08-05T11:58:47+05:30" itemprop="datePublished"> Aug 05, 2020 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Anuradha Chowdhary</span> </span> <time hidden datetime="" itemprop="dateModified"> Aug 05, 2020 </time> <span hidden itemprop="publisher" itemtype="Person">Anuradha Chowdhary</span> <span hidden itemprop="image">/airflow-concurrency-simplified/airflow.jpeg</span> <span hidden itemprop="mainEntityOfPage"><p>Anyone who goes beyond Airflow PoC and starts to build production grade data pipelines with Airflow would rquire to configure concurrent task execution. Unfortunately the documentation around it is scarce and to complicate the matter the configuration parameters are named in a very <a href="https://issues.apache.org/jira/browse/AIRFLOW-57" target="_blank">unintuitive and confusing way</a>.</p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>Anyone who goes beyond Airflow PoC and starts to build production grade data pipelines with Airflow would rquire to configure concurrent task execution. Unfortunately the documentation around it is scarce and to complicate the matter the configuration parameters are named in a very <a href="https://issues.apache.org/jira/browse/AIRFLOW-57" target="_blank">unintuitive and confusing way</a>.</p> <figure> <img src="confused.jpg" alt="confused" /> <figcaption style="color: grey !important;"> Photo by <a href="https://unsplash.com/@benwhitephotography" style="color: grey !important;" target="_blank">Ben White </a> </figcaption> </figure> <p>Though I canâ€™t change the name of the properties, I have made an attempt to decode the names. Hoefully it helps some of you, so that you can focus on more pressing problems in your data pipeline.</p> <h5 id="core"> <code class="language-plaintext highlighter-rouge">[core]</code> </h5> <p><strong><code class="language-plaintext highlighter-rouge">parallelism</code></strong> [ <a href="https://airflow.apache.org/docs/apache-airflow/stable/configurations-ref.html#parallelism" target="_blank">Ref</a> ]: Maximum number of task instances that can run concurrently on Airflow installation, i.e. the maximum number of task instances that can run in the entire airflow cluster. This is the only setting that applies to entire cluster as opposed to the given node. If you have two host running Airflow worker, combined total of task running on both workers will not exceed this value. You can also think of this is as maximum number of taks that will have state=â€™runningâ€™ in airflow metadata db. This value should be configured same on all the worker nodes of a given Airflow Cluster. The default value of <code class="language-plaintext highlighter-rouge">32</code>. If you are using <code class="language-plaintext highlighter-rouge">CeleryExecutor</code>, this should be sum of <code class="language-plaintext highlighter-rouge">worker_concurrency</code> for all nodes.</p> <p><strong><code class="language-plaintext highlighter-rouge">dag_concurrency</code></strong> [ <a href="https://airflow.apache.org/docs/apache-airflow/stable/configurations-ref.html#dag-concurrency" target="_blank">Ref</a> ]: This parameter determines how many task instances Airflow scheduler is able to schedule concurrently per DAG. This can be thought of as maximum tasks that can be scheduled concurrently, per DAG. Since schedular is global for cluster this property is also applicable to Airflow Cluster/installation as one entity. You should keep this value same on all the worker nodes of your Airflow Cluster. This parameter can be overwritten at DAG level by: <code class="language-plaintext highlighter-rouge">dag = DAG('example2', concurrency=10)</code></p> <p><strong><code class="language-plaintext highlighter-rouge">max_active_runs_per_dag</code></strong> [ <a href="https://airflow.apache.org/docs/apache-airflow/stable/configurations-ref.html#max_active_runs_per_dag" target="_blank">Ref</a> ]: This paramenter is important but does not really controls the concurrency directly, instead it specifies how many total runs of a DAG are allowed to run for the Airflow cluster. This helps in controling the fair allocation of resources and making sure that one DAG is not taking up all the resource. This parameter can be overwritten at DAG level by: <code class="language-plaintext highlighter-rouge">dag = DAG('my_dag_id', max_active_runs=1)</code></p> <h5 id="scheduler"> <code class="language-plaintext highlighter-rouge">[scheduler]</code> </h5> <p><strong><code class="language-plaintext highlighter-rouge">max_threads</code></strong> [ <a href="https://airflow.apache.org/docs/apache-airflow/stable/configurations-ref.html#max_threads" target="_blank">Ref</a> ]:The scheduler can run multiple threads in parallel to schedule dags. This parameter specifies how many threads will run scheduler run. Adjust this number based on CPU resources available - the higher the value, the more resources youâ€™ll need. Update: setting <a href="https://github.com/apache/airflow/pull/12605" target="_blank">has been renamed</a> to <code class="language-plaintext highlighter-rouge">parsing_processes</code> in airflow 2.0.</p> <h5 id="celery"> <code class="language-plaintext highlighter-rouge">[celery]</code> </h5> <p><strong><code class="language-plaintext highlighter-rouge">worker_concurrency</code></strong> [ <a href="https://airflow.apache.org/docs/apache-airflow/stable/configurations-ref.html#worker-concurrency" target="_blank">Ref</a> ]: This is the number of celery workers, per Airflow Worker. You would typically run one Airflow worker per Airflow node. So this can be considerd as per Airflow node version of <code class="language-plaintext highlighter-rouge">parallelism</code> setting. This is maximum number of task instances that can on a given Airflow worker can execute. You can have different settings for different worker node depending on number of available CPU Cores. This parameter has default value of <code class="language-plaintext highlighter-rouge">16</code>.</p> <p><strong><code class="language-plaintext highlighter-rouge">pool</code></strong> [ <a href="https://airflow.apache.org/docs/apache-airflow/stable/configurations-ref.html#pool" target="_blank">Ref </a> ]:<br /> This is type of celery pool implementation to be used and shold not be confused with <a href="https://airflow.apache.org/docs/apache-airflow/stable/concepts.html#pools" target="_blank">Airflow Pool</a>, which I will cover briefly later in this article. For this settings options are: prefork (default), eventlet, gevent or solo. For usual data pipelines, prefork works fine. If you have many I/O blocking tasks in your data pipelines, it is worth exploring gevent or eventlet. Please refer to <a href="https://www.distributedpython.com/2018/10/26/celery-execution-pool/" target="_blank">this post</a> on distributed python for more details on various options.</p> <p><strong><code class="language-plaintext highlighter-rouge">sync_parallelism</code></strong> [ <a href="https://airflow.apache.org/docs/apache-airflow/stable/configurations-ref.html#parallelism" target="_blank">Ref</a> ]: This is number of processes CeleryExecutor uses to sync task state. Value 0 implies to use max(1, number of cores - 1) processes.</p> <p><strong><code class="language-plaintext highlighter-rouge">worker_autoscale</code></strong> [ <a href="https://airflow.apache.org/docs/apache-airflow/stable/configurations-ref.html#worker-autoscale" target="_blank">Ref</a> ]: The maximum and minimum celery workers that will be per Airflow worker. Celery workers always keep minimum processes, but grow to maximum if necessary. Note the value should be max_concurrency,min_concurrency.You can have different settings for different worker node, based on resources on worker node and the nature of the task. If autoscale option is used, worker_concurrency will be ignored.</p> <h3 id="airflow-task-pools--ref-"> <a href="#airflow-task-pools--ref-" class="anchor-head"></a> Airflow Task Pools [ <a href="https://airflow.apache.org/docs/apache-airflow/stable/concepts.html#pools" target="_blank">Ref</a> ] </h3> <p>Airflow Pools can be defined using Airflow UI (Menu -&gt; Admin -&gt; Pools) or CLI. Tasks can then be associated with one of the existing pools by using the pool parameter when creating tasks in the DAG code: <code class="language-plaintext highlighter-rouge">my_task = PythonOperator(pool='my_custom_pool')</code></p> <p>Airflow pools are typically used to limit the concurrency on specific types of task. Some systems can get overwhelmed when too many processes hit them at the same time, e.g. downloading data from a webservice that limits concurrent connection. You can place limit by putting all such tasks to same pool and assigning a limit to the pool. This is great if you have a lot of workers in parallel, but you donâ€™t want to overwhelm a source or destination</p> <p>The pool parameter can be used in conjunction with priority_weight to define priorities in the queue, and which tasks get executed first as slots open up in the pool. The default priority_weight is 1, and can be bumped to any number. When sorting the queue to evaluate which task should be executed next, we use the priority_weight, summed up with all of the priority_weight values from tasks downstream from this task. You can use this to bump a specific important task and the whole path to that task gets prioritized accordingly.</p> <p>If tasks are not given a pool, they are assigned to a default pool default_pool which is initialized with 128 slots and can changed through the UI or CLI.</p> </div> </article> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/juppyter-hub-setup-simplified/" > <div class="nav-arrow">Previous</div> <span class="post-title">Jupyter Hub setup with Jupyter Lab.</span> </a> <a class="post-nav-item post-nav-next" href="/what-is-new-in-airflow-2.0/"> <div class="nav-arrow">Next</div> <span class="post-title">What's new in Airlow 2.0?</span> </a> </nav> <nav class="post-nav"></nav> <div id="disqus_thread"></div> <script> (function() { var d = document, s = d.createElement('script'); s.src = 'https://achowdhary.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <footer class="footer"> <a class="footer_item" href="/thanks">ack.</a> <a class="footer_item" href="javascript::void(0)">resume</a> <a class="footer_item" href="/feed.xml">rss</a> <!--span class="footer_item">&copy; 2021</span--> <small class="footer_copyright"> &copy 2021 Anuradha Chowdhary </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
